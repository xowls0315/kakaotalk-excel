# 실제 작업 흐름(과정) 아주 자세히

## (A) 프론트 담당 작업 예시 흐름

### 1) 프론트 브랜치로 이동

```bash
git checkout frontend
git pull origin frontend
```

### 2) 코드 작업 (frontend 폴더에서만)

`kakaotalk-excel-frontend/` 안에서 Next.js 작업

### 3) 커밋 & push

```bash
git add .
git commit -m "feat: upload page UI"
git push origin frontend
```

✅ 여기까지 하면 “frontend 브랜치에만” 반영됨.

---

## (B) develop로 합치기(통합 단계)

### 4) GitHub에서 PR 생성

GitHub 레포 → **Pull requests** → **New pull request**

- base: `develop` (합쳐질 대상)
- compare: `frontend` (네 작업 브랜치)

PR 제목 예:

- `Merge frontend into develop: upload UI`

### 5) 리뷰/승인(2인 팀이면 서로 해주기)

- 백 담당이 PR 확인 → Approve
- Merge 버튼으로 머지

✅ 이 순간부터 `develop`에 프론트 작업이 들어간다.

---

## (C) 백 담당도 동일

- `backend`에서 작업하고 push
- PR: `backend` → `develop`
- 머지

---

# 7) develop에서 통합 테스트는 누가/어떻게?

보통 “통합 책임자”를 정해. (2명이면 번갈아도 됨)

### develop 최신 받아서 통합 실행

```bash
git checkout develop
git pull origin develop
```

그리고:

- 프론트 실행
- 백 실행
- API 연결 테스트(Preview, Excel 다운로드)

✅ 통합이 깨지면?

- 깨진 쪽 담당자가 다시 자신의 브랜치(frontend/backend)에서 수정
- 수정사항 push
- 다시 PR → develop

---

# 8) 최종 배포(main)로 가는 과정

develop에서 통합 OK면:

### 1) PR 생성

- base: `main`
- compare: `develop`

### 2) 승인 후 merge

main에 반영됨 → 배포 트리거

## 0) 서비스 한 줄 정의

**“카카오톡 대화 내보내기(txt) 파일을 업로드하면, 대화 내용을 파싱해 미리보기/필터링 후 엑셀(xlsx)로 변환해주는 서비스.”**

- 게스트: 즉시 변환/다운로드(기록 저장은 제한)
- 로그인: 변환 기록 저장, 재다운로드, 설정 저장(템플릿)

---

## 1) 핵심 UX 플로우

### A. 게스트 플로우

1. 랜딩 → 업로드
2. preview(상위 N줄) + 필터 옵션 선택
3. 엑셀 생성 → 다운로드
4. (선택) “로그인하면 변환 기록 저장/재다운로드 가능” CTA

### B. 로그인 유저 플로우

1. 로그인(카카오 OAuth)
2. 업로드 → preview → 변환
3. “내 변환 기록”에서 작업 상태/다운로드 재요청
4. 설정 저장(기본 필터/템플릿)

### C. “게스트 → 로그인” 귀속(핵심)

- 게스트 상태로 변환한 작업들을 **로그인 후 내 계정으로 ‘연결(Claim)’** 가능하게 함
  (자세한 설계는 뒤 (4)에서)

---

## 2) 전체 아키텍처 (추천)

- **Next.js (App Router)**: 화면/상태/업로드/다운로드 UX
- **Nest.js**: 인증(OAuth+JWT), 업로드 처리, 파싱/정규화, 엑셀 생성, 작업 기록 관리
- **DB (TypeORM + MySQL/Postgres 중 택1)**: users, jobs, job_files, user_settings
- **파일 저장 방식**
  - MVP: 엑셀 파일을 서버 디스크/임시 저장 + 만료 삭제
  - 확장: S3/Supabase Storage(무료범위)로 이전 가능

---

# (1) Next.js 페이지 구조 (App Router)

### 라우트/페이지 제안

```
app/
  layout.tsx
  page.tsx                      (랜딩)
  (public)/
    upload/page.tsx             (업로드)
    preview/page.tsx            (미리보기/옵션)
    result/page.tsx             (다운로드 완료/안내)
    guide/page.tsx              (대화 내보내기 방법)
    auth/callback/page.tsx      (로그인 콜백 처리 UI)
  (user)/
    dashboard/page.tsx          (내 변환 기록)
    jobs/[jobId]/page.tsx       (작업 상세/재다운로드)
    settings/page.tsx           (설정 저장)
  api/                          (필요시 Next API route - 가능하면 최소화)
components/
  UploadDropzone.tsx
  PreviewTable.tsx
  FiltersPanel.tsx
  JobListTable.tsx
  LoginButton.tsx
	Header.tsx
  Footer.tsx
lib/
  apiClient.ts                  (fetchwrapper, credentials 포함)
  auth.ts                       (로그인 상태 확인)
  download.ts                   (blob 다운로드)
  constants.ts
store/
  useAuthStore.ts               (zustand 추천)
  useConvertStore.ts
```

### 페이지별 책임

- `/` 랜딩: 기능 소개 + “바로 변환하기” + “로그인하면 기록 저장”
- `/upload`: 드래그&드롭 업로드 + 파일 포맷 안내 + 샘플 다운로드(선택)
- `/preview`: 파싱 결과 미리보기 테이블 + 필터(기간/참여자/시스템 메시지) + “엑셀로 변환”
- `/result`: 성공 안내 + 게스트면 로그인 유도(Claim CTA)
- `/dashboard`: 내 작업 목록(상태: processing/success/expired/failed) + 다운로드 버튼
- `/jobs/[jobId]`: 작업 상세(옵션, 생성일, 파일 만료일 등)
- `/settings`: 기본 옵션 저장(예: 시스템 메시지 제외 기본, 날짜 범위 기본 등)

### 프론트 상태 설계(추천)

- 인증 상태: `GET /auth/me`로 확인
- 게스트 식별: 서버가 주는 `guest_session` 쿠키 기반(프론트는 신경 최소화)
- 변환 옵션 상태: preview 페이지에서 store에 저장 → excel 요청에 그대로 포함

---

# (2) Nest Auth 모듈 구조 + 엔드포인트 명세

## 모듈 구조(추천)

```
src/
  app.module.ts
  config/
  auth/
    auth.module.ts
    auth.controller.ts
    auth.service.ts
    strategies/
      kakao.strategy.ts          (passport-kakao)
      jwt.strategy.ts            (passport-jwt)
    guards/
      jwt-auth.guard.ts
    dto/
			login-response.dto.ts
  users/
    users.module.ts
    users.service.ts
    users.controller.ts
    entities/user.entity.ts
  jobs/
    jobs.module.ts
    jobs.controller.ts
    jobs.service.ts
    entities/job.entity.ts
    entities/job-file.entity.ts
    dto/
      preview-request.dto.ts
      preview-response.dto.ts
      excel-request.dto.ts
parser/
parser.module.ts
parser.service.ts            (kakao txt 파서)
  excel/
    excel.module.ts
    excel.service.ts             (xlsx 생성)
  settings/
    settings.module.ts
    settings.controller.ts
    settings.service.ts
    entities/user-setting.entity.ts
  common/
    decorators/current-user.decorator.ts
    filters/http-exception.filter.ts
    interceptors/logging.interceptor.ts
```

---

## 인증 방식(권장)

- **Refresh Token: httpOnly 쿠키**
- **Access Token: Authorization Bearer(또는 쿠키로도 가능)**
- Next.js는 API 호출 시 `credentials: "include"` 사용

---

## Auth 엔드포인트 명세

### 1) 로그인 시작

**GET** `/auth/kakao`

- 카카오 OAuth로 리다이렉트

### 2) 콜백

**GET** `/auth/kakao/callback`

- 성공 시:
  - refreshToken 쿠키 세팅
  - accessToken을 query로 전달하거나(보안 주의) **프론트 리다이렉트 후 서버에서 /auth/me 호출하는 방식** 추천
- 실패 시: 에러 페이지로 리다이렉트

### 3) 현재 로그인 정보

**GET** `/auth/me`

- 응답(로그인):

```json
{ "id": 1, "nickname": "홍길동", "provider": "kakao" }
```

- 비로그인: 401

### 4) 토큰 재발급

**POST** `/auth/refresh`

- refresh 쿠키 기반으로 access 재발급

### 5) 로그아웃

**POST** `/auth/logout`

- refresh 쿠키 삭제 + 서버 저장 refresh 무효화(권장)

---

## Jobs/Convert 엔드포인트 명세

### (게스트/로그인 공통) Preview

**POST** `/convert/preview`

- `multipart/form-data`
  - file: txt
  - options: JSON(string) (예: includeSystem, dateFrom, dateTo)
- 응답:

```json
{
  "jobId": "uuid-or-number",
  "roomName": "채팅방명(추정)",
  "messages": [
    {
      "at": "2025-12-29T10:12:00+09:00",
      "sender": "A",
      "message": "...",
      "type": "text"
    }
  ],
  "participants": ["A", "B"],
  "stats": { "totalLines": 12345, "previewCount": 200 }
}
```

- 서버 동작:
  - Job 레코드 생성(게스트면 guestSessionId로)
  - 파싱 → 미리보기 반환

### (게스트/로그인 공통) Excel 생성 + 다운로드

**POST** `/convert/excel`

- `multipart/form-data`
  - file: txt (또는 preview에서 jobId 기반으로 재생성도 가능)
  - options: JSON
- 응답: 엑셀 파일 스트리밍 다운로드
- 서버 동작:
  - Job 업데이트(status=processing → success/failed)
  - 결과 파일 저장(job_files 생성) + 만료시간 설정
  - 스트리밍으로 내려줌

### (로그인 전용) 내 작업 목록

**GET** `/jobs`

- query: `status`, `page`, `size`
- 응답: job 리스트 + 만료/다운로드 링크 정보

### (로그인 전용) 작업 상세

**GET** `/jobs/:jobId`

### (로그인 전용) 재다운로드

**GET** `/jobs/:jobId/download`

- 만료 전이면 파일 제공
- 만료면 410 Gone 또는 “재생성 필요” 응답

---

# (3) DB 스키마 (TypeORM 엔티티 설계)

## 3-1. User

- 카카오 로그인 기반 유저

**users**

- id (PK)
- provider (`kakao`)
- providerUserId (카카오 유저 id)
- email (nullable)
- nickname
- createdAt, updatedAt

## 3-2. GuestSession (선택, 있어도 좋음)

**guest_sessions**

- id (PK, uuid)
- createdAt, lastSeenAt
- userAgentHash (optional)

> MVP에선 굳이 테이블 없이, guest_session 쿠키값만 써도 돼.
>
> 하지만 “귀속/보안/만료 관리”를 위해 테이블 추천.

## 3-3. Job (변환 작업)

**jobs**

- id (PK, uuid 추천)
- userId (nullable FK → users.id)
- guestSessionId (nullable) ← 게스트 작업 연결용
- originalFileName
- status (`previewed|processing|success|failed|expired`)
- optionsJson (필터/설정)
- roomName (nullable)
- totalMessages (nullable)
- createdAt, finishedAt

## 3-4. JobFile (결과 파일)

**job_files**

- id (PK)
- jobId (FK)
- storageType (`local|s3|supabase`)
- pathOrUrl
- sizeBytes
- expiresAt
- createdAt

## 3-5. UserSetting (기본 옵션 저장)

**user_settings**

- id (PK)
- userId (FK unique)
- defaultIncludeSystem (bool)
- defaultSplitSheetsByDay (bool)
- defaultDateRangeDays (int nullable)
- createdAt, updatedAt

---

# (4) “게스트 → 로그인” 작업 귀속(Claim) 방법 (가장 중요)

여기서 핵심은:

**게스트가 작업을 만들 때 “식별자”가 있어야 로그인 후 그 작업들을 찾고 userId로 업데이트 할 수 있어.**

## 추천 방식: “guest_session 쿠키 + Claim API”

### 1) 게스트 첫 방문 시

- 백엔드 미들웨어가 `guest_session` 쿠키가 없으면 생성해서 내려줌 (uuid)
- 이후 게스트 작업 생성 시 `jobs.guestSessionId = cookie 값`

### 2) 로그인 성공 시

- 프론트는 `/auth/me`로 로그인 확인
- 그 다음 **자동으로 Claim 호출**
  - **POST** `/jobs/claim`
  - 서버는 “현재 로그인 userId” + “현재 요청의 guest_session 쿠키”를 읽어서:
    - `jobs` 중 `guestSessionId = 쿠키값 AND userId IS NULL` 인 것들을 전부 `userId=현재유저`로 업데이트
    - (선택) guestSession을 만료 처리하거나 그대로 유지

### 3) Claim 이후 UX

- `/dashboard`로 이동시키면, 방금 게스트로 만들었던 작업들이 “내 기록”에 나타남
- 결과: “로그인하면 내 기록으로 저장”이 실제로 구현됨

### Claim 엔드포인트 예시

**POST** `/jobs/claim` (JWT 필요)

- 응답:

```json
{ "claimed": 3 }
```

### 보안/주의 포인트

- guest_session 쿠키는 **httpOnly + sameSite=lax** 권장
- 다른 사람이 쿠키를 훔치지 못하게 HTTPS 환경 필수(배포 시)
- Claim은 “최근 N일 이내 job만” 귀속되게 제한하면 안전(예: 7일)

---

# 프론트엔드 / 백엔드 A–Z 체크리스트 (실행 순서)

아래는 팀이 그대로 진행하면 되는 “개발 순서표”야.

(알파벳은 단계 구분용, 실제 일정은 1~2주 스프린트로 끊으면 딱 좋아)

## ✅ 공통(기획/협업)

**A. MVP 범위 확정**: 업로드→preview→excel / 로그인→기록/재다운로드/설정

**B. 샘플 파일 확보**: 카톡 내보내기 txt 5개 이상(폰/OS/버전 다양)

**C. API 계약서 작성**: request/response, 에러코드, 파일 제한(용량/줄 수)

**D. 레포/브랜치 전략**: develop + feature/… 규칙

---

## ✅ 프론트엔드(Next.js) A–Z

**A. App Router 구조 생성**: (public)/(user) 그룹 라우트

**B. 공통 레이아웃(Header/Footer) + CTA 배치**

**C. API Client 구현**: `credentials: 'include'`, 에러 공통 처리

**D. 업로드 UI**: 드래그&드롭 + 파일 검증(txt)

**E. Preview 호출/렌더**: 테이블(200개 미리보기), participants, stats

**F. 필터 패널**: 기간/시스템메시지 포함/시트 분할 옵션

**G. Excel 다운로드 처리**: blob 다운로드 유틸

**H. 로그인 버튼/상태**: `/auth/kakao` 이동, `/auth/me`로 상태 갱신

**I. 로그인 콜백 페이지**: “로그인 중…” 처리 후 `/jobs/claim` 호출

**J. 대시보드**: `/jobs` 호출 → 리스트/상태 뱃지/다운로드 버튼

**K. 작업 상세**: `/jobs/:jobId` 상세 표시, 만료 안내

**L. 설정 페이지**: `/settings` 조회/저장 UI

**M. 가이드 페이지**: “대화 내보내기 방법” 이미지/텍스트

**N. 에러 UX**: 포맷 불일치/빈파일/용량 초과 안내

**O. 접근성/반응형**: 모바일 업로드 고려

**P. 배포(Vercel)**: env(API_BASE_URL), 도메인 연결

---

## ✅ 백엔드(Nest.js) A–Z

**A. 프로젝트 세팅**: ConfigModule, ValidationPipe, CORS(쿠키 허용)

**B. DB 연결(TypeORM)**: users/jobs/job_files/user_settings

**C. guest_session 미들웨어**: 쿠키 생성/갱신

**D. Auth 모듈**: kakao strategy, jwt, refresh 쿠키 발급

**E. /auth/me /refresh /logout** 구현

**F. Parser 서비스**: 카카오 txt 파서(멀티라인/시스템메시지 처리)

**G. /convert/preview**: 업로드 → job 생성 → 파싱 → 미리보기 반환

**H. Excel 서비스**: xlsx 생성, 열 너비/줄바꿈/시트 분할

**I. /convert/excel**: 생성 → job_files 저장 → 스트리밍 응답

**J. Jobs API**: /jobs 목록/상세/다운로드

**K. Claim API**: /jobs/claim (guest→user 귀속)

**L. Settings API**: /settings GET/PUT

**M. 만료/삭제 정책**: job_files.expiresAt 기반 스케줄러(크론)로 파일 삭제

**N. 로깅/모니터링**: 에러 로깅, 처리시간 측정

**O. 보안**: 파일 업로드 제한(확장자/용량), 원문 저장 최소화

**P. 배포(Render/Fly 등)**: HTTPS, 쿠키 옵션(sameSite/secure) 조정

---

## “이 설계가 프로젝트에서 예쁘게 보이는 포인트”

- **무로그인도 즉시 사용 가능**(진입장벽↓)
- **로그인하면 실제로 서비스가 ‘축적’됨**(기록/재다운로드/설정)
- “guest_session + claim”은 면접에서 설명하기 좋은 실전 패턴임

---

원하면 다음 턴에서 내가 바로 실전용으로 뽑아줄게:

1. **Next.js 라우트별 컴포넌트 골격 코드**
2. **Nest 엔티티(TypeORM) 코드 + 마이그레이션 흐름**
3. **Auth(카카오) + refresh 쿠키 발급 예시 코드**
4. **/convert/preview, /convert/excel 컨트롤러/서비스 샘플 코드**

너희 팀은 **DB를 MySQL로 갈지 Postgres로 갈지**, 그리고 **배포는 Render/Fly/VPS 중 뭐로 할지** 대충 방향만 말해줘. 그 기준으로 코드/설정을 딱 맞춰서 써줄게.
